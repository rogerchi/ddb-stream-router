# Project Structure

## Directory Layout

```
.
├── src/                    # Source code
├── test/                   # Unit and property tests
├── examples/               # Usage examples
├── integ/                  # Integration tests with CDK
├── lib/                    # Compiled output (generated)
├── .projen/                # Projen metadata (generated)
└── .kiro/                  # Kiro configuration
```

## Source Code (`src/`)

- **index.ts** - Main exports and public API
- **stream-router.ts** - Core router implementation and HandlerRegistration class
- **types.ts** - TypeScript type definitions and interfaces
- **middleware.ts** - Middleware functions (e.g., unmarshallMiddleware)
- **sqs-adapter.ts** - SQS client adapter for deferred processing
- **attribute-diff.ts** - Attribute change detection and diffing logic
- **errors.ts** - Custom error classes (ConfigurationError)

## Test Organization (`test/`)

Tests are organized by feature:
- **event-processing.test.ts** - Core event routing tests
- **batch-processing.test.ts** - Batch mode handler tests
- **deferred-processing.test.ts** - SQS deferral tests
- **middleware.test.ts** - Middleware chain tests
- **stream-view-types.test.ts** - Different stream view type tests
- **nested-attributes.test.ts** - Nested attribute filtering tests
- **set-attributes.test.ts** - Set/List collection change tests
- **zod-integration.test.ts** - Zod schema validation tests
- **stream-router.property.test.ts** - Property-based tests with fast-check
- **test-utils.ts** - Shared test utilities and helpers

## Examples (`examples/`)

Runnable examples demonstrating library features:
- **basic-usage.ts** - Simple INSERT/MODIFY/REMOVE handlers
- **with-zod-parser.ts** - Using Zod schemas for validation
- **attribute-filtering.ts** - Reacting to specific attribute changes
- **batch-processing.ts** - Grouping records for batch processing
- **middleware.ts** - Using middleware for logging/filtering
- **deferred-processing.ts** - Deferring heavy work to SQS
- **global-tables.ts** - Region filtering for global tables
- **stream-view-types.ts** - Handling different stream view types

## Integration Tests (`integ/`)

CDK-based integration tests:
- **stack.ts** - CDK stack definition (DynamoDB table, Lambda, SQS)
- **handler.ts** - Lambda handler for integration testing
- **run-tests.ts** - Test runner script
- **cdk.json** - CDK configuration

## Key Patterns

### Handler Registration
Handlers are registered using a fluent API and return `HandlerRegistration` objects that support chaining with `.defer()`.

### Discriminators vs Parsers
- **Discriminators** - Type guard functions: `(record: unknown) => record is T`
- **Parsers** - Schema validators with `safeParse` method (e.g., Zod schemas)

### Batch Processing
Batch handlers collect matching records and invoke once per batch. Records can be grouped by attribute value or primary key using `batchKey` option.

### Deferred Processing
Handlers marked with `.defer(id)` enqueue records to SQS instead of executing immediately. The same router processes deferred records via `processDeferred()`.

### Middleware Chain
Middleware executes in registration order. If middleware doesn't call `next()`, the handler chain is skipped for that record.

## Generated Files

DO NOT manually edit these files (regenerated by projen):
- `package.json`
- `tsconfig.json`
- `tsconfig.dev.json`
- `.gitignore`
- `.npmignore`
- `.github/workflows/*`
- `.projen/*`
- `biome.jsonc`

To modify these files, edit `.projenrc.ts` and run `npx projen`.
